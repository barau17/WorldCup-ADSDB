import os
import pandas as pd
import duckdb
import re

from Utilities.os_utilities import createDirectory
from paths import trustedZoneTables, exploitationDataBaseDir, exploitationZoneTables

# Moving all the data sources from the trusted zone to the exploitation zone where we are going to aggregate all the data for the analysis

def loadDataFromTrustedToExploitationDatabase(trustedZoneTables):
    try:
        con = duckdb.connect(database=f'{exploitationDataBaseDir}exploitation_WorldCup.duckdb', read_only=False)

        # Define a regular expression pattern to match the table name
        pattern = r"^(.*?)_(\d{4}_\d{2}_\d{2})\.csv$"

        files = [f for f in os.listdir(trustedZoneTables) if f.endswith('.csv')]

        for f in files:
            print(os.path.join(trustedZoneTables, f))
            match = re.match(pattern, f)
            if match:
                table_name = match.group(1)
                date = match.group(2)

                if "matches" in table_name:
                    df = pd.read_csv(os.path.join(trustedZoneTables, f))
                    con.execute(f'CREATE TEMPORARY TABLE temp_Matches AS SELECT * FROM df')
                elif "player" in table_name and "appearances" in table_name:
                    df = pd.read_csv(os.path.join(trustedZoneTables, f))
                    con.execute(f'CREATE TEMPORARY TABLE temp_Player_Appears AS SELECT * FROM df')
                elif "player" in table_name and "appearances" not in table_name:
                    df = pd.read_csv(os.path.join(trustedZoneTables, f))
                    con.execute(f'CREATE TEMPORARY TABLE temp_Players AS SELECT * FROM df')
                elif "referee" in table_name and "appearances" in table_name:
                    df = pd.read_csv(os.path.join(trustedZoneTables, f))
                    con.execute(f'CREATE TEMPORARY TABLE temp_Ref_Appears AS SELECT * FROM df')
                elif "referee" in table_name and "appearances" not in table_name:
                    df = pd.read_csv(os.path.join(trustedZoneTables, f))
                    con.execute(f'CREATE TEMPORARY TABLE temp_Refs AS SELECT * FROM df')

        # Perform the joins -> Creating a table with players and referee information per match
        con.execute(f'CREATE TEMPORARY TABLE temp_Matches1 AS SELECT * FROM temp_Matches a LEFT JOIN (SELECT * FROM temp_Player_Appears) b ON a.match_id = b.match_id')
        con.execute(f'CREATE TEMPORARY TABLE temp_MatchesF AS SELECT * FROM temp_Matches1 a LEFT JOIN (SELECT * FROM temp_Ref_Appears) b ON a.match_id = b.match_id')

        # Export them into the Exploitation zone
        con.execute(f'CREATE OR REPLACE TABLE MatchesComplete AS SELECT * FROM temp_MatchesF')
        # Move the updated table to the Exploitation zone
        destination_path = os.path.join(exploitationZoneTables, f'MatchesComplete.csv')
        con.execute(f"COPY MatchesComplete TO '{destination_path}' (HEADER, DELIMITER ',')")

        con.close()  

    except Exception as e:
        print(e)
        con.close()

def main():
    createDirectory(exploitationDataBaseDir)
    createDirectory(exploitationZoneTables)

    loadDataFromTrustedToExploitationDatabase(trustedZoneTables)

if __name__ == "__main__":
    main()